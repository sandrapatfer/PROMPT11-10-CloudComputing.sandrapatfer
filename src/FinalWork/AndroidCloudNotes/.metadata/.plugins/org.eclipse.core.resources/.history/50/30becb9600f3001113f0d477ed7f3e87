package prompt.cloudnotes.activities;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.List;

import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;
import org.json.JSONException;
import org.json.JSONObject;

import prompt.cloudnotes.CloudNotesApp;
import prompt.cloudnotes.Utils;
import prompt.cloudnotes.services.GetInfoService;
import prompt.cloudnotes.services.GetLocalInfoService;
import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;

public class LoginActivity extends Activity {
	
	public static final String CODE_TAG = "code";
	
	private CloudNotesApp _application;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);

		_application = (CloudNotesApp)getApplication();

		if (Token.isEmpty()) {

			Log.d(CloudNotesApp.TAG, "Launching login browser");
			Intent intent = new Intent();
			intent.setClass(this, AuthActivity.class);
			startActivityForResult(intent, 0);
		}

	}

	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		super.onActivityResult(requestCode, resultCode, data);

		Log.d(CloudNotesApp.TAG, "LoginActivity.onActivityResult");

		if (requestCode != 0) {
			return;
		}
		
		if (resultCode == RESULT_OK && data != null) {
			String code = data.getStringExtra(CODE_TAG);
			_application.ProcessOAuthCode(code);
		}
		else if (resultCode == RESULT_CANCELED) {
			Log.d(CloudNotesApp.TAG, "Starting service to get data from local storage");
			Intent msg = new Intent();
			msg.setClass(this, GetLocalInfoService.class);
			startService(msg);

			Log.d(CloudNotesApp.TAG, "Starting lists activity");
			Intent lists = new Intent();
			lists.setClass(this, TaskListsActivity.class);
			startActivity(lists);			
		}
	}
}
